# Бот-Двойник

Telegram-бот, который автоматически собирает сообщения участников чата, формирует актуальные "слепки стиля" и по запросу имитирует выбранного пользователя с помощью модели OpenAI `gpt-5-nano`.

## Возможности
- Автоматический сбор сообщений и хранение последних N фраз для каждого участника чата.
- Имитация участника по команде `/imitate @username [текст-затравка]`.
- Автоответы в стиле упомянутого пользователя (при включённом режиме автоимитации).
- Команда `/imitate_profiles` показывает статус собранных профилей.

## Быстрый старт
1. Создайте файл `.env` или задайте переменные окружения:
   ```env
   TELEGRAM_BOT_TOKEN=...  # токен бота от BotFather (обязательно)
   OPENAI_API_KEY=...      # ключ OpenAI (обязательно)
   ```

   Дополнительные параметры (все имеют значения по умолчанию и задаются при необходимости):

   | Переменная | Назначение | Значение по умолчанию |
   | --- | --- | --- |
   | `BOT_DOUBLE_DB_PATH` | путь к SQLite-базе | `bot_double.db` |
   | `AUTO_IMITATE_PROBABILITY` | шанс автоимитации при упоминании | `0.2` |
   | `MIN_MESSAGES_FOR_PROFILE` | минимум сообщений для построения профиля | `20` |
   | `MAX_MESSAGES_PER_USER` | сколько сообщений хранить на пользователя | `200` |
   | `PROMPT_SAMPLE_SIZE` | размер выборки стиля для промпта | `30` |
   | `DIALOG_CONTEXT_MESSAGES` | сколько последних сообщений подмешивать как контекст | `6` |
   | `STYLE_RECENT_MESSAGES` | сколько свежих сообщений отдавать модели первым | `5` |
   | `PEER_PROFILE_COUNT` | сколько «соседей» собирать для бэкграунда | `3` |
   | `PEER_PROFILE_SAMPLES` | сколько сообщений брать у каждого соседа | `2` |
   | `OPENAI_MODEL` | модель для имитаций | `gpt-5-nano` |
   | `OPENAI_REASONING_EFFORT` | усилие рассуждений (`minimal/low/medium/high`) | пусто (выкл) |
   | `OPENAI_TEXT_VERBOSITY` | многословность (`low/medium/high`) | пусто (дефолт модели) |
   | `MIN_TOKENS_TO_STORE` | минимальное число слов для мгновенного сохранения | `3` |
   | `SHORT_MESSAGE_BUFFER_SECONDS` | таймаут агрегации коротких сообщений | `10` |
   | `RELATIONSHIP_ANALYSIS_MODEL` | модель для соцаналитика (если пусто — `OPENAI_MODEL`) | пусто |
   | `RELATIONSHIP_ANALYSIS_MIN_PENDING` | сколько обращений накопить перед анализом пары | `5` |
   | `RELATIONSHIP_ANALYSIS_MIN_HOURS` | пауза между анализами одной пары (часы) | `24` |
   | `PERSONA_ANALYSIS_MODEL` | модель для карточек персоны (если пусто — `OPENAI_MODEL`) | пусто |
   | `PERSONA_ANALYSIS_MIN_MESSAGES` | сколько новых реплик накопить перед обновлением карточки | `50` |
   | `PERSONA_ANALYSIS_MAX_MESSAGES` | сколько сообщений подавать модели (верхний предел) | `100` |
   | `PERSONA_ANALYSIS_MIN_HOURS` | минимальный интервал между карточками (часы) | `24` |

2. Установите зависимости:
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```

3. Запустите бота:
   ```bash
   python main.py
   ```

## Команды
- `/imitate @username [текст]` — сгенерировать ответ в стиле пользователя.
- `/imitate_profiles` — показать, чьи профили готовы.
- `/auto_imitate_on` / `/auto_imitate_off` — включить или отключить автопародию в чате.
- `/dialogue @user1 @user2 [тема]` — разыграть мини-диалог между двумя участниками в их стиле.
- `/forgetme` — удалить все сохранённые сообщения и профиль пользователя.

Бот также периодически переанализирует пары собеседников, чтобы лучше понимать их отношения и тон общения. Это улучшает контекст в имитациях и диалогах.

Каждый активный участник получает «карточку персоны»: раз в сутки модель пересматривает его сообщения (50–100 штук) и формирует сжатый портрет — интересы, чувство юмора, эмоциональность, общий тон и речевые привычки. Эти карточки автоматически подмешиваются в промпты имитации и диалогов, делая ответы заметно точнее.

## Хранение данных
Все данные сохраняются в SQLite (по умолчанию `bot_double.db`). Для каждого пользователя бот хранит скользящее окно из последних `MAX_MESSAGES_PER_USER` сообщений. При превышении лимита старые записи автоматически удаляются.
